---
title: "15 Insights from Alaska School Enrollment Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{15 Insights from Alaska School Enrollment Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
NOT_CRAN <- identical(tolower(Sys.getenv("NOT_CRAN")), "true")
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE,
  fig.width = 8,
  fig.height = 5,
  eval = NOT_CRAN
)
```

```{r load-packages, eval=TRUE}
library(akschooldata)
library(dplyr)
library(tidyr)
library(ggplot2)

theme_set(theme_minimal(base_size = 14))

# Get available year range from package
available <- get_available_years()
min_year <- available$min_year
max_year <- available$max_year
all_years <- min_year:max_year
```

This vignette explores Alaska's public school enrollment data, surfacing key trends and demographic patterns across `r length(all_years)` years of data (`r min_year`-`r max_year`).

*Note: This vignette fetches live data from the Alaska Department of Education. Run locally with `NOT_CRAN=true` to see computed output and charts.*

---

## 1. Alaska's enrollment is sliding south

Alaska's public school enrollment has been in steady decline, dropping from around 132,000 to under 130,000 students in recent years. The Last Frontier is losing families.

```{r statewide-trend}
enr <- fetch_enr_multi(all_years)

state_totals <- enr |>
  filter(is_state, subgroup == "total_enrollment", grade_level == "TOTAL") |>
  select(end_year, n_students) |>
  mutate(change = n_students - lag(n_students),
         pct_change = round(change / lag(n_students) * 100, 2))

state_totals
```

```{r statewide-chart}
ggplot(state_totals, aes(x = end_year, y = n_students)) +
  geom_line(linewidth = 1.2, color = "#003366") +
  geom_point(size = 3, color = "#003366") +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = paste0("Alaska Public School Enrollment (", min_year, "-", max_year, ")"),
    subtitle = "Steady decline as families leave the Last Frontier",
    x = "School Year (ending)",
    y = "Total Enrollment"
  )
```

---

## 2. Anchorage is half the state

The Anchorage School District educates nearly half of all Alaska students. When Anchorage sneezes, Alaska catches a cold.

```{r top-districts}
enr_latest <- fetch_enr(max_year)

top_districts <- enr_latest |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") |>
  arrange(desc(n_students)) |>
  head(10) |>
  select(district_name, n_students)

top_districts
```

```{r top-districts-chart}
top_districts |>
  mutate(district_name = forcats::fct_reorder(district_name, n_students)) |>
  ggplot(aes(x = n_students, y = district_name, fill = district_name)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = scales::comma(n_students)), hjust = -0.1, size = 3.5) +
  scale_x_continuous(labels = scales::comma, expand = expansion(mult = c(0, 0.15))) +
  scale_fill_viridis_d(option = "mako", begin = 0.2, end = 0.8) +
  labs(
    title = paste0("Top 10 Alaska Districts by Enrollment (", max_year, ")"),
    subtitle = "Anchorage dominates with nearly half of all students",
    x = "Number of Students",
    y = NULL
  )
```

---

## 3. Post-COVID enrollment shifts

The pandemic's effects on enrollment continue to ripple through Alaska's districts. Some areas show signs of recovery while others continue to decline.

```{r post-covid-impact}
# Compare 2021 to 2022
covid_years <- 2021:2022
post_covid_enr <- fetch_enr_multi(covid_years)

covid_changes <- post_covid_enr |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         end_year %in% covid_years) |>
  pivot_wider(names_from = end_year, values_from = n_students, names_prefix = "y") |>
  mutate(pct_change = round((y2022 / y2021 - 1) * 100, 1)) |>
  arrange(pct_change) |>
  head(10) |>
  select(district_name, y2021, y2022, pct_change)

covid_changes
```

---

## 4. Alaska Native students are a quarter of enrollment

Alaska Native and American Indian students make up about 22-25% of enrollment statewide--far higher than any other state except Hawaii.

```{r demographics}
demographics <- enr_latest |>
  filter(is_state, grade_level == "TOTAL",
         subgroup %in% c("native_american", "white", "asian", "black", "hispanic", "multiracial")) |>
  mutate(pct = round(pct * 100, 1)) |>
  select(subgroup, n_students, pct) |>
  arrange(desc(n_students))

demographics
```

```{r demographics-chart}
demographics |>
  mutate(subgroup = forcats::fct_reorder(subgroup, n_students)) |>
  ggplot(aes(x = n_students, y = subgroup, fill = subgroup)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = paste0(pct, "%")), hjust = -0.1) +
  scale_x_continuous(labels = scales::comma, expand = expansion(mult = c(0, 0.15))) +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = paste0("Alaska Student Demographics (", max_year, ")"),
    subtitle = "Alaska Native students comprise a quarter of enrollment",
    x = "Number of Students",
    y = NULL
  )
```

---

## 5. Kindergarten predicts the future

Kindergarten enrollment is the canary in the coal mine. Alaska's K numbers have been weak for years, signaling more decline ahead.

```{r k-vs-12}
grade_trends <- enr |>
  filter(is_state, subgroup == "total_enrollment",
         grade_level %in% c("K", "12")) |>
  select(end_year, grade_level, n_students) |>
  pivot_wider(names_from = grade_level, values_from = n_students)

grade_trends
```

```{r k-trend-chart}
enr |>
  filter(is_state, subgroup == "total_enrollment",
         grade_level %in% c("K", "12")) |>
  ggplot(aes(x = end_year, y = n_students, color = grade_level)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::comma) +
  scale_color_manual(values = c("K" = "#E69F00", "12" = "#56B4E9")) +
  labs(
    title = "Kindergarten vs 12th Grade Enrollment",
    subtitle = "Weak kindergarten numbers signal continued decline",
    x = "School Year",
    y = "Enrollment",
    color = "Grade"
  )
```

---

## 6. The Mat-Su Valley bucks the trend

While Anchorage shrinks, the Matanuska-Susitna Borough School District (Palmer/Wasilla area) has been growing, attracting families leaving the big city.

```{r matsu-trend}
matsu <- enr |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         grepl("Mat-Su|Matanuska", district_name, ignore.case = TRUE)) |>
  select(end_year, district_name, n_students)

matsu
```

```{r anchorage-matsu-chart}
enr |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         grepl("Mat-Su|Matanuska|Anchorage", district_name, ignore.case = TRUE)) |>
  group_by(district_name) |>
  mutate(index = round(n_students / first(n_students) * 100, 1)) |>
  ggplot(aes(x = end_year, y = index, color = district_name)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  geom_hline(yintercept = 100, linetype = "dashed", color = "gray50") +
  labs(
    title = "Anchorage vs Mat-Su: Diverging Paths",
    subtitle = paste0("Indexed to ", min_year, " = 100"),
    x = "School Year",
    y = "Enrollment Index",
    color = "District"
  )
```

---

## 7. Rural districts are disappearing

Small rural districts with fewer than 100 students face existential challenges. Some haven't reported enrollment in recent years.

```{r small-districts}
small_districts <- enr_latest |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") |>
  filter(n_students < 200) |>
  arrange(n_students) |>
  select(district_name, n_students)

small_districts
```

---

## 8. The graduation pipeline leaks

The gap between 9th grade and 12th grade enrollment reveals retention challenges that vary dramatically by district.

```{r graduation-pipeline}
pipeline <- enr_latest |>
  filter(is_district, subgroup == "total_enrollment",
         grade_level %in% c("09", "12")) |>
  pivot_wider(names_from = grade_level, values_from = n_students) |>
  mutate(ratio = round(`12` / `09` * 100, 1)) |>
  filter(`09` >= 50) |>
  arrange(ratio) |>
  head(10) |>
  select(district_name, `09`, `12`, ratio)

pipeline
```

---

## 9. Fairbanks is shrinking faster than Anchorage

Fairbanks North Star Borough School District has seen steeper percentage declines than Anchorage in recent years. The interior is emptying out.

```{r fairbanks-anchorage}
major_districts <- enr |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         grepl("Fairbanks|Anchorage", district_name)) |>
  mutate(district_simple = case_when(
    grepl("Anchorage", district_name) ~ "Anchorage",
    grepl("Fairbanks", district_name) ~ "Fairbanks",
    TRUE ~ district_name
  )) |>
  group_by(district_simple) |>
  mutate(index = round(n_students / first(n_students) * 100, 1)) |>
  select(end_year, district_simple, n_students, index)

major_districts
```

```{r fairbanks-anchorage-chart}
enr |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         grepl("Fairbanks|Anchorage", district_name)) |>
  mutate(district_simple = case_when(
    grepl("Anchorage", district_name) ~ "Anchorage",
    grepl("Fairbanks", district_name) ~ "Fairbanks",
    TRUE ~ district_name
  )) |>
  group_by(district_simple) |>
  mutate(index = round(n_students / first(n_students) * 100, 1)) |>
  ggplot(aes(x = end_year, y = index, color = district_simple)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  geom_hline(yintercept = 100, linetype = "dashed", color = "gray50") +
  scale_color_manual(values = c("Anchorage" = "#003366", "Fairbanks" = "#CC5500")) +
  labs(
    title = "Fairbanks vs Anchorage: Who's Shrinking Faster?",
    subtitle = paste0("Indexed to ", min_year, " = 100"),
    x = "School Year",
    y = "Enrollment Index",
    color = "District"
  )
```

---

## 10. Alaska's geography creates unique schools

Some Alaska schools are only accessible by plane or boat. These remote schools serve communities of fewer than 50 students across areas larger than some states.

```{r smallest-districts}
smallest <- enr_latest |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") |>
  arrange(n_students) |>
  head(10) |>
  select(district_name, n_students)

smallest
```

---

## 11. Distance education is Alaska's secret

Alaska pioneered distance education out of necessity. Schools like IDEA (Interior Distance Education of Alaska) now serve more students than most districts, with families across the state enrolled in correspondence programs.

```{r distance-ed}
distance_schools <- enr_latest |>
  filter(is_campus, subgroup == "total_enrollment", grade_level == "TOTAL") |>
  filter(grepl("IDEA|Correspondence|Distance|Central School|Raven|Cyber|Connections", campus_name, ignore.case = TRUE)) |>
  arrange(desc(n_students)) |>
  head(10) |>
  select(district_name, campus_name, n_students)

distance_schools
```

```{r distance-ed-chart}
distance_schools |>
  mutate(campus_name = forcats::fct_reorder(campus_name, n_students)) |>
  ggplot(aes(x = n_students, y = campus_name, fill = district_name)) +
  geom_col() +
  geom_text(aes(label = scales::comma(n_students)), hjust = -0.1, size = 3.5) +
  scale_x_continuous(labels = scales::comma, expand = expansion(mult = c(0, 0.15))) +
  scale_fill_viridis_d(option = "plasma", begin = 0.2, end = 0.8) +
  labs(
    title = paste0("Top Distance/Correspondence Programs (", max_year, ")"),
    subtitle = "IDEA alone serves more students than most Alaska districts",
    x = "Number of Students",
    y = NULL,
    fill = "District"
  ) +
  theme(legend.position = "bottom")
```

---

## 12. Pre-K is bouncing back

Pre-Kindergarten enrollment took a hit during the pandemic but has been recovering steadily. Early childhood education is making a comeback in the Last Frontier.

```{r prek-trend}
prek_trend <- enr |>
  filter(is_state, subgroup == "total_enrollment", grade_level == "PK") |>
  select(end_year, n_students) |>
  mutate(change = n_students - lag(n_students),
         pct_change = round(change / lag(n_students) * 100, 1))

prek_trend
```

```{r prek-chart}
ggplot(prek_trend, aes(x = end_year, y = n_students)) +
  geom_line(linewidth = 1.2, color = "#9B59B6") +
  geom_point(size = 3, color = "#9B59B6") +
  geom_text(aes(label = scales::comma(n_students)), vjust = -1, size = 3.5) +
  scale_y_continuous(labels = scales::comma, expand = expansion(mult = c(0.05, 0.15))) +
  labs(
    title = paste0("Pre-K Enrollment Trend (", min_year, "-", max_year, ")"),
    subtitle = "Early childhood education recovering from pandemic dip",
    x = "School Year",
    y = "Pre-K Enrollment"
  )
```

---

## 13. Elementary shrinks while high school grows

A tale of two pipelines: Elementary enrollment (K-5) is declining while high school (9-12) continues to grow. This reflects both demographic shifts and the echo of larger cohorts moving through the system.

```{r elem-vs-hs}
level_trends <- enr |>
  filter(is_state, subgroup == "total_enrollment") |>
  mutate(level = case_when(
    grade_level %in% c("K", "01", "02", "03", "04", "05") ~ "Elementary (K-5)",
    grade_level %in% c("06", "07", "08") ~ "Middle (6-8)",
    grade_level %in% c("09", "10", "11", "12") ~ "High School (9-12)",
    TRUE ~ NA_character_
  )) |>
  filter(!is.na(level)) |>
  group_by(end_year, level) |>
  summarize(n_students = sum(n_students), .groups = "drop")

level_trends
```

```{r elem-vs-hs-chart}
level_trends |>
  group_by(level) |>
  mutate(index = round(n_students / first(n_students) * 100, 1)) |>
  ggplot(aes(x = end_year, y = index, color = level)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  geom_hline(yintercept = 100, linetype = "dashed", color = "gray50") +
  scale_color_manual(values = c("Elementary (K-5)" = "#E74C3C", "Middle (6-8)" = "#F39C12", "High School (9-12)" = "#27AE60")) +
  labs(
    title = "Diverging Trends by School Level",
    subtitle = paste0("Indexed to ", min_year, " = 100"),
    x = "School Year",
    y = "Enrollment Index",
    color = "Level"
  ) +
  theme(legend.position = "bottom")
```

---

## 14. Twelve students, one district

Pelican City School District serves just 12 students--but under Alaska law, it still operates as a full district. These micro-districts reflect Alaska's commitment to educating even the most remote communities.

```{r micro-districts}
micro_districts <- enr_latest |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") |>
  filter(n_students < 150) |>
  arrange(n_students) |>
  select(district_name, n_students) |>
  head(10)

micro_districts
```

```{r micro-districts-chart}
micro_districts |>
  mutate(district_name = forcats::fct_reorder(district_name, n_students)) |>
  ggplot(aes(x = n_students, y = district_name)) +
  geom_col(fill = "#3498DB") +
  geom_text(aes(label = n_students), hjust = -0.3, size = 3.5) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.15))) +
  labs(
    title = paste0("Alaska's Smallest Districts (", max_year, ")"),
    subtitle = "Full districts serving tiny, remote communities",
    x = "Total Enrollment",
    y = NULL
  )
```

---

## 15. Borough districts dominate

Alaska's borough school districts (regional governments) serve far more students than city districts. The 14 borough districts enroll nearly 53,000 students, while 12 city districts serve just 12,000.

```{r borough-city}
dist_types <- enr_latest |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") |>
  mutate(dist_type = case_when(
    grepl("Borough", district_name) ~ "Borough District",
    grepl("City", district_name) ~ "City District",
    TRUE ~ "Other (REAAs, etc.)"
  )) |>
  group_by(dist_type) |>
  summarize(
    n_districts = n(),
    total_students = sum(n_students),
    .groups = "drop"
  ) |>
  mutate(avg_students = round(total_students / n_districts))

dist_types
```

```{r borough-city-chart}
dist_types |>
  mutate(dist_type = forcats::fct_reorder(dist_type, total_students)) |>
  ggplot(aes(x = total_students, y = dist_type, fill = dist_type)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = paste0(scales::comma(total_students), " (", n_districts, " districts)")),
            hjust = -0.05, size = 3.5) +
  scale_x_continuous(labels = scales::comma, expand = expansion(mult = c(0, 0.25))) +
  scale_fill_manual(values = c("Borough District" = "#1ABC9C", "City District" = "#E67E22", "Other (REAAs, etc.)" = "#95A5A6")) +
  labs(
    title = paste0("Enrollment by District Type (", max_year, ")"),
    subtitle = "Borough districts serve far more students than city districts",
    x = "Total Enrollment",
    y = NULL
  )
```

---

## Summary

Alaska's school enrollment data reveals:

- **Steady decline**: The Last Frontier is losing students year over year
- **Anchorage dominance**: One district educates nearly half the state
- **Distance education boom**: Correspondence programs serve thousands statewide
- **Urban-suburban shift**: Mat-Su grows while Anchorage and Fairbanks shrink
- **Rural resilience**: Tiny bush districts persist against long odds
- **Early childhood recovery**: Pre-K bouncing back from pandemic lows
- **Pipeline divergence**: Elementary shrinks while high school grows

These patterns shape school funding debates and facility planning across America's largest and most remote state.

---

*Data sourced from the Alaska Department of Education and Early Development [Data Center](https://education.alaska.gov/data-center).*
